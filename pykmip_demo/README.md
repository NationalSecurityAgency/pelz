# PyKMIP Usage Demo

## Introduction
This outlines the steps required to create an end-to-end demo of pelz using both Accumulo and
PyKMIP. **These steps are intended for demonstration purposes only, they are not intended for
operational use.** The demo demonstrates the ability for Accumulo to request a key-encryption-key
stored within PyKMIP. Pelz processes this request, retrieves the key, and uses it to wrap/unwrap
file keys for Accumulo. Although the demo is intended to run in an SGX simulator, this demonstrates
a process for retrieving a key from a key server and using a trusted-execution environment to
protect it while serving cloud software.

These instructions detail the install and setup processes for Accumulo, pelz, PyKMIP, and a proxy
server. They proxy server coordinates communication between pelz and PyKMIP. This is because pelz
does not support TLS endpoints within the Trusted-Exceuction Environment (TEE). The instructions
then explain how to build Accumulo and run its unit tests using pelz and PyKMIP. The unit tests
require successful functionality of the PelzCryptoService within Accumulo to protect the file-
encryption-keys (FEKs) by using the key-encryption-key (KEK) stored within the PyKMIP server. 

## Keys-in-use demonstration process

The process for key protections is outlined here:  

1. Accumulo generates a FEK for its internal file encryption
2. Accumulo sends the FEK to pelz to be encrypted by the KEK. This request contains the KEK's
  Unique Identification (UID)
3. Pelz connects to the proxy server from within the TEE using an ECDH key establishment
4. The proxy server forwards the key request to the PyKMIP server using TLS
5. PyKMIP verifies the request and sends the KEK back to the pelz enclave through the proxy server
6. Pelz uses the KEK within the enclave to encrypt/decrypt FEKs as per Accumulo's requests

## Keys and Certificates

The demonstration has four cert/key pairs and two keys for encryption. The two encryption keys are:  

 * The file-encryption-key (FEK)
 * The key-encryption-key (KEK) 

The KEK is stored on the PyKMIP server. It is used to wrap and unwrap FEKs as requested by Accumulo.
The FEK is generated by Accumulo for its internal file protections.  

The four certificate/key pairs are:  

 * One certificate for the node
 * Two for the proxy server
 * One for PyKMIP server

The proxy server has two certificate/key pairs to protect both the connection to the node and the
connection to the PyKMIP server.

## Steps for End to End demo of PyKMIP, Accumulo, and pelz. 
The remainder of this README describes the process for installing the necessary tools to execute
the demonstration. These instructions omit the installation and setup of an SGX emulator. This must
be done prior to executing the demo.

### Pelz Installation Steps
1.  Open terminal
2.	Clone pelz repo and follow install instructions

		git clone https://github.com/NationalSecurityAgency/pelz.git
		cd pelz

### Accumulo and Accumulo Plugin Installation Steps 
3. Download the Accumulo source and setup pelz plugin

		cd ..
		git clone https://github.com/apache/accumulo.git
		sudo apt install maven openjdk-11-jdk libxml2-utils
		cd pelz/accumulo_plugin
		./setup_plugin.sh -i -d ~/accumulo/ -p
		cd ..

### PyKMIP Server Installation/Setup Steps
4.  Run PyKMIP Script

		./pykmip_demo/PyKMIP_setup.sh

5.  Run the server in a separate terminal

		pykmip-server

6.  Register keys with the server

		python3 pykmip_demo/register_keys_pykmip.py


### Certificate and PKey Creation/Installation Steps
7.	Generate Certificates and PKeys for server and client then seal

		cd test/data
		./gen_test_keys_certs.bash
		openssl x509 -in proxy_pub.pem -inform pem -out proxy_pub.der -outform der
		openssl pkey -in node_priv.pem -inform pem -out node_priv.der -outform der
		cd ../..
		./bin/pelz seal test/data/proxy_pub.der -o test/data/proxy_pub.der.nkl
		./bin/pelz seal test/data/node_priv.der -o test/data/node_priv.der.nkl

8.	Run the pelz-service in a separate terminal

		cd pelz
		./bin/pelz-service -m 200 -v

9.	Load server certificate and client PKey

		./bin/pelz pki load cert test/data/proxy_pub.der.nkl
		./bin/pelz pki load private test/data/node_priv.der.nkl

### Proxy Server Setup Steps
10.	Build and run the proxy server in a separate terminal

		cd pelz/kmyth/sgx
		make clean demo-all
		cd ../..
		./kmyth/sgx/demo/bin/tls-proxy -r test/data/proxy_priv.pem -u test/data/node_pub.pem -p 7000 -I localhost -P 5690 -C /etc/pykmip/certs/root_certificate.pem -R /etc/pykmip/certs/proxy_priv.pem -U /etc/pykmip/certs/proxy_pub.pem

### End to End Demo Step
11. Run Accumulo Test

		cd ../accumulo
		mvn clean
		mvn test

