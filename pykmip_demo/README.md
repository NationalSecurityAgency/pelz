# Key Encryption Key (KEK) in-use Protection Demonstration 

## Introduction
This part of the project demonstrates how to use the pelz key service to protect the most sensitive 
keys used by the Accumulo database management software, the key encryption keys (KEKs). 

**This code is intended for demonstration purposes only, it is not intended for operational use.**

Accumulo encryption and decryption capabilities are documented at [Accumulo On Disk encryption](https://accumulo.apache.org/docs/2.x/security/on-disk-encryption). 
PelzCryptoService is a custom implementation of the Accumulo CryptoService interface that supports 
pelz integration. Accumulo is easily configured to use PelzCryptoService instead of the default 
AESCryptoService (or any other custom) implementation. In an encrypted Accumulo database, data is 
stored in RFiles encrypted with file encryption keys (FEKs). The FEKs are key-wrapped using KEKs 
and stored, in addition to the encrypted data, as part of the RFile. 

In this demo, we assume that the KEKs are initially stored in a KMIP key server, which we simulate 
using [PyKMIP](https://github.com/OpenKMIP/PyKMIP). Here we demonstrate the ability for Accumulo 
to request that pelz wrap or unwrap an FEK, using a KEK hosted by a PyKMIP server. Pelz processes 
this request, retrieves the KEK, and uses it to wrap/unwrap FEKs for Accumulo. The KEKs are 
protected from compromise throughout this process; they are stored securely on the KMIP key server, 
sent to pelz through a secure communication channel, and protected in use within the pelz trusted 
execution environment (TEE). Although intended to run in an SGX simulator, this code demonstrates 
a process that can be employed for securely retrieving a key from a key server, and then using a 
hardware rooted TEE to protect it while serving a cloud-based application. 

These instructions detail the install and setup processes for Accumulo, pelz, PyKMIP, and a proxy 
server. The proxy server coordinates communication between pelz and PyKMIP. This is because pelz 
does not support TLS endpoints within the TEE. The instructions then explain how to build Accumulo 
and run its unit tests using pelz and PyKMIP. The unit tests verify that the PelzCryptoService 
functionality within Accumulo correctly protects sample file encryption keys (FEKs) using a key 
encryption key (KEK) stored within a PyKMIP server. 

## Keys-in-use demonstration process

The process for key protections is outlined here:  

1. Accumulo generates a FEK for its internal file encryption
2. Accumulo sends the FEK to pelz to be encrypted by the KEK. This request contains the KEK's
  Unique Identification (UID)
3. Pelz connects to the proxy server from within the TEE using an ECDH key establishment
4. The proxy server forwards the key request to the PyKMIP server using TLS
5. PyKMIP verifies the request and sends the KEK back to the pelz enclave through the proxy server
6. Pelz uses the KEK within the enclave to encrypt/decrypt FEKs as per Accumulo's requests

## Keys and Certificates

The demonstration has four cert/key pairs and two keys for encryption. The two encryption keys are:  

 * The file-encryption-key (FEK)
 * The key-encryption-key (KEK) 

The KEK is stored on the PyKMIP server. It is used to wrap and unwrap FEKs as requested by Accumulo.
The FEK is generated by Accumulo for its internal file protections.  

The four certificate/key pairs are:  

 * One certificate for the node
 * Two for the proxy server
 * One for PyKMIP server

The proxy server has two certificate/key pairs to protect both the connection to the node and the
connection to the PyKMIP server.

## Steps for End to End demo of PyKMIP, Accumulo, and pelz. 
The remainder of this README describes the process for installing the necessary tools to execute
the demonstration on Ubuntu 18. These instructions omit the installation and setup of an SGX emulator. This must
be done prior to executing the demo. If the demo is attempted on another Linux distribution, the following steps 
are not guaranteed to work.

### Pelz Installation Steps
1.  Open terminal
2.	Clone pelz repo

		git clone https://github.com/NationalSecurityAgency/pelz.git
		cd pelz

3.  Follow the install/build instuctions to make pelz 

### Accumulo and Accumulo Plugin Installation Steps 
4. Download the Accumulo source and setup pelz plugin

		cd ..
		git clone https://github.com/apache/accumulo.git
		sudo apt install maven openjdk-11-jdk libxml2-utils
		cd pelz/accumulo_plugin
		./setup_plugin.sh -i -d ~/accumulo/ -p
		cd ..

### PyKMIP Server Installation/Setup Steps
5.  Run PyKMIP Script

		./pykmip_demo/PyKMIP_setup.sh

6.  Run the server in a separate terminal

		pykmip-server

7.  Register keys with the server

		python3 pykmip_demo/register_keys_pykmip.py


### Certificate and PKey Creation/Installation Steps
8.	Generate Certificates and PKeys for server and client then seal

		cd test/data
		./gen_test_keys_certs.bash
		cd ../..
		./bin/pelz seal test/data/proxy_pub.der -o test/data/proxy_pub.der.nkl
		./bin/pelz seal test/data/node_pub.der -o test/data/node_pub.der.nkl
		./bin/pelz seal test/data/node_priv.der -o test/data/node_priv.der.nkl

9.	Run the pelz-service in a separate terminal

		cd pelz
		./bin/pelz-service -m 200 -v

10.	Load server/client certificate and client PKey

		./bin/pelz pki load cert test/data/proxy_pub.der.nkl
		./bin/pelz pki load cert test/data/node_pub.der.nkl
		./bin/pelz pki load private test/data/node_priv.der.nkl

### Proxy Server Setup Steps
11.	Build and run the proxy server in a separate terminal

		cd pelz/kmyth/sgx
		make clean demo-all demo-test-keys-certs 
		cd ../..
		./kmyth/sgx/demo/bin/tls-proxy -r test/data/proxy_priv.pem -c test/data/proxy_pub.pem -u test/data/node_pub.pem -p 7000 -I localhost -P 5690 -C /etc/pykmip/certs/root_certificate.pem -R /etc/pykmip/certs/proxy_priv.pem -U /etc/pykmip/certs/proxy_pub.pem -m 1

### End to End Demo Step
12. Run Accumulo Test

		cd ../accumulo
		mvn clean
		mvn test

## Steps for demo of PyKMIP and pelz. 
The remainder of this README describes the process for installing the necessary tools to execute
this demonstration on Ubuntu 18. These instructions omit the installation and setup of an SGX emulator. This must
be done prior to executing the demo. If the demo is attempted on another Linux distribution, the following steps
are not guaranteed to work.

### Pelz Installation Steps
1.  Open terminal
2.  Clone pelz repo

		git clone https://github.com/NationalSecurityAgency/pelz.git
		cd pelz

3.  Follow the install/build instuctions to make pelz

### PyKMIP Server Installation/Setup Steps
4.  Run PyKMIP Script

		./pykmip_demo/PyKMIP_setup.sh

5.  Run the server in a separate terminal

		pykmip-server

6.  Register keys with the server

		python3 pykmip_demo/register_keys_pykmip.py

### Certificate and PKey Creation/Installation Steps
8.  Generate Certificates and PKeys for server and client then seal

		cd test/data
		./gen_test_keys_certs.bash
		cd ../..

### Proxy Server Setup Steps
11. Build and run the proxy server in a separate terminal

		cd kmyth/sgx
		make clean demo-all demo-test-keys-certs
		cd ../..
		./kmyth/sgx/demo/bin/tls-proxy -r test/data/proxy_priv.pem -c test/data/proxy_pub.pem -u test/data/node_pub.pem -p 7000 -I localhost -P 5690 -C /etc/pykmip/certs/root_certificate.pem -R /etc/pykmip/certs/proxy_priv.pem -U /etc/pykmip/certs/proxy_pub.pem -m 1

### Demo PyKMIP and pelz
12. Run pelz test

		./test/bin/pelz-test

